name: deploy instance repo

on:
    push:

jobs:
    deploy:
        runs-on: ubuntu-latest

        env:
            PYTHON_VERSION: "3.9"
            # directory in which cookiecuter generates the new repository
            INSTANCE_DIR: "TEMPLATE_INSTANCE"
            PROJECT_NAME: "project-name"

        steps:
            - uses: actions/checkout@v3
            - name: Set up Python ${{ env.PYTHON_VERSION }}
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Get pip cache dir
              id: pip-cache-dir
              run: |
                  echo "::set-output name=dir::$(pip cache dir)"
            - name: Restore pip cache
              uses: actions/cache@v2
              with:
                  path: ${{ steps.pip-cache-dir.outputs.dir }}
                  key: pip-${{ runner.os }}-${{ env.pythonLocation }}-${{ hashFiles('**/pyproject.toml') }}
                  restore-keys: |
                      pip-${{ runner.os }}-${{ env.pythonLocation }}-

            - name: Install cookiecutter
              run: |
                  python -m pip install --upgrade pip wheel cookiecutter pre-commit

            - name: Build from template
              run: |
                  cookiecutter --output-dir $INSTANCE_DIR --no-input .

            - name: Commit changes
              uses: EndBug/add-and-commit@v9
              with:
                  default_author: github_actions
                  commit: "--no-verify" # no need to run pre-commit at this point - saves runtime!
                  cwd: ${{ env.INSTANCE_DIR }}/${{ env.PROJECT_NAME }}
                  message: Generate instance repo from cookiecutter template
                  new_branch: ${{ github.ref }}
                  push: false

            - name: Deploy to instance repo
              uses: ad-m/github-push-action@master
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch: ${{ github.ref }}
                  repository: scverse/cookiecutter-scverse-instance
                  force: true
                  directory: ${{ env.INSTANCE_DIR }}/${{ env.PROJECT_NAME }}
